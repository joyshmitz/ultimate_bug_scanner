name: Checksum Sync

on:
  push:
    branches: ["master"]
    paths:
      - "ubs"
      - "SHA256SUMS"
  pull_request:
    paths:
      - "ubs"
      - "SHA256SUMS"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: checksum-sync-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  sync-checksums:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Need write access for auto-commit on push to master
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Compute current checksum
        id: compute
        run: |
          ACTUAL=$(sha256sum ubs | awk '{print $1}')
          EXPECTED=$(awk '{print $1}' SHA256SUMS 2>/dev/null || echo "")
          echo "actual=$ACTUAL" >> "$GITHUB_OUTPUT"
          echo "expected=$EXPECTED" >> "$GITHUB_OUTPUT"
          if [[ "$ACTUAL" == "$EXPECTED" ]]; then
            echo "match=true" >> "$GITHUB_OUTPUT"
            echo "::notice::SHA256SUMS is up to date"
          else
            echo "match=false" >> "$GITHUB_OUTPUT"
            echo "::warning::SHA256SUMS is stale (expected $EXPECTED, actual $ACTUAL)"
          fi

      - name: Verify checksums (PR only)
        if: github.event_name == 'pull_request' && steps.compute.outputs.match == 'false'
        run: |
          echo "::error::SHA256SUMS does not match ubs script!"
          echo ""
          echo "Expected: ${{ steps.compute.outputs.expected }}"
          echo "Actual:   ${{ steps.compute.outputs.actual }}"
          echo ""
          echo "Please run: ./scripts/update_sha256sums.sh"
          echo "Or manually: sha256sum ubs > SHA256SUMS"
          exit 1

      - name: Auto-update SHA256SUMS (push to master only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/master' && steps.compute.outputs.match == 'false'
        run: |
          echo "${{ steps.compute.outputs.actual }}  ubs" > SHA256SUMS
          echo "Updated SHA256SUMS to: $(cat SHA256SUMS)"

      - name: Commit and push updated checksums
        if: github.event_name == 'push' && github.ref == 'refs/heads/master' && steps.compute.outputs.match == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add SHA256SUMS
          git commit -m "chore(checksum): auto-update SHA256SUMS [skip ci]

          Updated checksum: ${{ steps.compute.outputs.actual }}

          This commit was automatically generated by the checksum-sync workflow."
          git push
